name: Create New Blog Post

# Updated: Fixed heredoc syntax
on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Blog post title'
        required: true
        type: string
      filename:
        description: 'Filename (slug, lowercase-with-hyphens, without .md)'
        required: true
        type: string
      description:
        description: 'Short description of the post'
        required: false
        type: string
        default: ''
      tags:
        description: 'Comma-separated tags (e.g., "tech, tutorial, javascript")'
        required: false
        type: string
        default: ''
      publish_now:
        description: 'Publish immediately (uncheck to save as draft)'
        required: false
        type: boolean
        default: false

jobs:
  create:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Create Blog Post
        env:
          TITLE: ${{ inputs.title }}
          DESCRIPTION: ${{ inputs.description }}
          TAGS: ${{ inputs.tags }}
        run: |
          POST_FILE="src/content/blog/${{ inputs.filename }}.md"

          if [ -f "$POST_FILE" ]; then
            echo "Error: Post file $POST_FILE already exists!"
            exit 1
          fi

          # Create frontmatter
          TODAY=$(date +%Y-%m-%d)
          if [ "${{ inputs.publish_now }}" == "true" ]; then
            DRAFT_LINE=""
          else
            DRAFT_LINE="draft: true"
          fi

          # Process tags into YAML array format
          TAGS_LINE=""
          if [ -n "$TAGS" ]; then
            IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
            TAGS_LINE="tags: ["
            for i in "${!TAG_ARRAY[@]}"; do
              TAG=$(echo "${TAG_ARRAY[$i]}" | xargs)
              if [ $i -eq 0 ]; then
                TAGS_LINE+="\"$TAG\""
              else
                TAGS_LINE+=", \"$TAG\""
              fi
            done
            TAGS_LINE+="]"
          fi

          # Create the blog post file
          {
            echo "---"
            echo "title: \"$TITLE\""
            echo "description: \"$DESCRIPTION\""
            echo "publishDate: $TODAY"
            [ -n "$DRAFT_LINE" ] && echo "$DRAFT_LINE"
            [ -n "$TAGS_LINE" ] && echo "$TAGS_LINE"
            echo "---"
            echo ""
            echo "Write your blog post content here..."
            echo ""
            echo "## Section 1"
            echo ""
            echo "Your content goes here."
            echo ""
            echo "## Section 2"
            echo ""
            echo "More content here."
          } > "$POST_FILE"

          echo "Created new blog post at $POST_FILE"
          cat "$POST_FILE"

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/content/blog/${{ inputs.filename }}.md

          if [ "${{ inputs.publish_now }}" == "true" ]; then
            git commit -m "Add new blog post: ${{ inputs.title }}"
          else
            git commit -m "Add new draft blog post: ${{ inputs.title }}"
          fi

          git push

      - name: Summary
        run: |
          echo "âœ… Blog post created successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ inputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Filename:** ${{ inputs.filename }}.md" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $( [ '${{ inputs.publish_now }}' == 'true' ] && echo 'Published' || echo 'Draft' )" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:** ${{ inputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.publish_now }}" == "true" ]; then
            echo "ðŸš€ The post will be deployed to your site shortly." >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ The post is saved as a draft. Use the 'Publish Blog Post' workflow to publish it later." >> $GITHUB_STEP_SUMMARY
          fi
